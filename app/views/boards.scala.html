@(fps: Int, secs: Int)(implicit request: play.api.mvc.RequestHeader)
@main("Conway's Game of Life") {
    <pre id="board"><i id="cell" class="E"></i></pre>
    <pre id="stats">&nbsp;<br/>&nbsp;</pre>
    @helper.javascriptRouter("jsRoutes")(
        routes.javascript.GameController.stream
    )
    <script type="text/javascript">
            if (typeof (EventSource) === undefined) {
                document.getElementById('board').innerHTML =
                        "Sorry. This browser doesn't seem to support server sent events. Check <a href='http://html5test.com/compare/feature/communication-eventSource.html'>html5test</a> for browser compatibility.";
            } else {
                (function () {
                    const boardElem = document.querySelector('#board');
                    const statsElem = document.querySelector('#stats');

                    function updateBoard(event) {
                        let buffer = '';
                        for (const c of event.data) {
                            if ('A' <= c && c <= 'Z') {
                                buffer += `<i class="${c}"></i>`;
                            } else {
                                buffer += c;
                            }
                        }
                        boardElem.innerHTML = buffer;
                    }

                    let timing = [];
                    let generation = 0, index = 0;

                    function updateStats() {
                        const now = performance.now();
                        timing[index++] = now;
                        index %= 100;
                        let stats;
                        if (10 <= ++generation) {
                            const then = timing[index % timing.length], rate = 1e3 * timing.length / (now - then);
                            stats = `Generation: ${generation}<br/>Events / Second: ${rate.toFixed(1)}`;
                        } else {
                            stats = `Generation: ${generation}`;
                        }
                        statsElem.innerHTML = stats;
                        statsElem.setAttribute("style", 'padding-left:' + Math.abs((generation / @(fps / 2) +80) % 160 - 80) + '%');
                    }

                    function resetStats() {
                        timing = [];
                        generation = index = 0;
                    }

                    let source;

                    function resetSource(cols, rows) {
                        if (source) {
                            source.close();
                            resetStats();
                        }
                        source = new EventSource(jsRoutes.controllers.GameController.stream(cols, rows, @secs).url);
                        source.addEventListener('message', updateBoard);
                        source.addEventListener('message', updateStats);
                        source.addEventListener('close', resetStats);
                    }

                    const cellElem = document.querySelector('#cell');
                    const boardHeight = boardElem.offsetHeight;
                    const cellWidth = cellElem.offsetWidth;
                    const statsHeight = statsElem.offsetHeight;
                    let pendingUpdate = false;

                    function viewportHandler() {
                        if (pendingUpdate) {
                            return;
                        }
                        pendingUpdate = true;

                        requestAnimationFrame(() => {
                            pendingUpdate = false;

                            let cols = Math.floor(visualViewport.width / cellWidth);
                            let rows = Math.floor((visualViewport.height - statsHeight) / boardHeight) - 2;

                            resetSource(cols, rows);
                        });
                    }

                    visualViewport.onresize = viewportHandler;

                    viewportHandler();
                })();
            }
    </script>
}
